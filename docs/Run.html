<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Run</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Run.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption empty">&nbsp;</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Run</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Networking</a></li><li><a href="#g:2">Message handling</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>The main logic for the bot. Implements the core networking functionality,
as well as finding and applying callbacks.</p><p>There's a list of callbacks in <code><a href="Scripting.html#v:callbacks">callbacks</a></code>, and for each message,
we will invoke all functions in there that successfully pattern match the
message.</p><p>Support for non-blocking calls on Windows is poor, so we implement our own
non-blocking, using a listener thread that blocks, and an MVar between that
and the main thread. We can do non-blocking reads on the MVar reliably.</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:startBot">startBot</a> :: <a href="Bot.html#t:Bot">Bot</a> ()</li><li class="src short"><a href="#v:listenMain">listenMain</a> :: MVar String -&gt; <a href="Bot.html#t:Bot">Bot</a> ()</li><li class="src short"><a href="#v:listenH">listenH</a> :: Handle -&gt; MVar String -&gt; IO ()</li><li class="src short"><a href="#v:handleLine">handleLine</a> :: String -&gt; <a href="Bot.html#t:Bot">Bot</a> ()</li><li class="src short"><a href="#v:applyCallbacks">applyCallbacks</a> :: <a href="Msg.html#t:SMsg">SMsg</a> -&gt; <a href="Bot.html#t:Bot">Bot</a> ()</li><li class="src short"><a href="#v:tryApply">tryApply</a> :: (a -&gt; b) -&gt; a -&gt; Maybe b</li></ul></div><div id="interface"><h1 id="g:1">Networking</h1><div class="top"><p class="src"><a id="v:startBot" class="def">startBot</a> :: <a href="Bot.html#t:Bot">Bot</a> () <a href="#v:startBot" class="selflink">#</a></p><div class="doc"><p>Startup. We should already have initialised global variables about the server and
 nick from the config, and we use those to connect to the server, sending registration
 info, then starting the listening loop.</p></div></div><div class="top"><p class="src"><a id="v:listenMain" class="def">listenMain</a> :: MVar String -&gt; <a href="Bot.html#t:Bot">Bot</a> () <a href="#v:listenMain" class="selflink">#</a></p><div class="doc"><p>The main listening loop: check whether <code><a href="Run.html#v:listenH">listenH</a></code> has read a line,
 and process that if there is one.</p></div></div><div class="top"><p class="src"><a id="v:listenH" class="def">listenH</a> :: Handle -&gt; MVar String -&gt; IO () <a href="#v:listenH" class="selflink">#</a></p><div class="doc"><p>Listen on the socket provided, writing lines we get into the <code>MVar</code>.</p></div></div><h1 id="g:2">Message handling</h1><div class="top"><p class="src"><a id="v:handleLine" class="def">handleLine</a> :: String -&gt; <a href="Bot.html#t:Bot">Bot</a> () <a href="#v:handleLine" class="selflink">#</a></p><div class="doc"><p>Handle a line - message string - from the server, invoking the appropriate callbacks.</p></div></div><div class="top"><p class="src"><a id="v:applyCallbacks" class="def">applyCallbacks</a> :: <a href="Msg.html#t:SMsg">SMsg</a> -&gt; <a href="Bot.html#t:Bot">Bot</a> () <a href="#v:applyCallbacks" class="selflink">#</a></p><div class="doc"><p>Apply all message callbacks in <code><a href="Scripting.html#v:callbacks">callbacks</a></code> which pattern-match the message.</p></div></div><div class="top"><p class="src"><a id="v:tryApply" class="def">tryApply</a> :: (a -&gt; b) -&gt; a -&gt; Maybe b <a href="#v:tryApply" class="selflink">#</a></p><div class="doc"><p>Try to apply <code>f</code> to <code>v</code> - if pattern matching on the argument fails,
 return <code>Nothing</code>. Otherwise return <code>Just (f v)</code>. Used to match callbacks.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.17.2</p></div></body></html>